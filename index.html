<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Fantasy Fantasy</title>
        <link rel="icon" type="image/svg" href="./assets/favicon.svg">

        <link rel="stylesheet" href="./assets/rpg-awesome.min.css" />

        <style>
         @font-face {
           font-family: RPGAwesome;
           src: url("fonts/rpgawesome-webfont.woff?v=0.1.0") format("woff");
         }
         @font-face {
           font-family: ysabeau;
           src: url("fonts/YsabeauOffice-VariableFont_wght.ttf") format("truetype");
         }
         @font-face {
           font-family: varsity;
           src: url("fonts/VarsityTeamBold.otf") format("opentype");
         }
         @font-face {
           font-family: devinneswash;
           src: url("fonts/DevinneSwash.ttf") format("truetype");
         }

         @font-face {
           font-family: vinque;
           src: url("fonts/Vinque Rg.otf") format("opentype");
         }

         :root {
           --boxGap: 0.5rem;
           --sidebarWidth: 22vw;

           --topFontSize: clamp(0.75rem, 1.5vw, 2rem);

           --bgColor: #010101;
           --baseColor: #e0e0e0;
           --boxColor: #e0e0e0;
           --accent: hsl(120, 82.5%, 45%);
           --accent: hsl(190, 82.5%, 45%);
         }


         *, *::before, *::after {
           box-sizing: border-box;
           scrollbar-width: none;
           -webkit-tap-highlight-color: transparent;
           -webkit-user-drag: none;
         }

         .box {
           background: var(--bgColor);
           border: 2px solid var(--boxColor);
           border-radius: 3px;
           padding: var(--boxGap);
         }

         html, body {
           padding: 0;
           margin: 0;
           width: 100%;
           height: 100%;
           overflow: hidden;
         }

         /* ASSUMES MOBILE */
         
         body {
           background: var(--bgColor);
           color: var(--baseColor);
           font-family: ysabeau, monospace;
           display: grid;
           grid-template-rows: auto 1fr 0.5fr 0.15fr;
           grid-template-areas:
             "header header header"
             "main main main"
             "right right right"
             "updates updates updates";
           gap: var(--boxGap);
           padding: var(--boxGap);
           padding-bottom: calc(var(--boxGap) + 1px); /* extra pixel feels right */
         }

         p, h1, h2, h3 {
           margin: 0;
         }

         *:has(> .filler) { display: flex; justify-content: center; align-items: center;}         

         #navbar {
           grid-area: header;
           display: flex;
           gap: var(--boxGap);
           overflow-x: auto;
           justify-content: center;
           flex: 1;
           align-items: center;
           width: 100%;
         }
         
         #navbar button {
           display: flex;
           align-items: center;
           justify-content: center;
           flex-grow: 1;
           color: var(--baseColor);
           height: 100%;
           font-weight: 600;
           font-size: 1.55rem;
           box-shadow: inset 0 0 0 1.5px var(--bgColor);

           transition: background 0.05s, border 0.05s, box-shadow 0.05s, scale 0.05s;
           white-space: nowrap;
           cursor: pointer;
           img {
             height: 1em;
             filter: invert(0.97);
             user-select: none;
           }

           &:focus, &:active, &.chosen {
             outline: none;

             &:is(#field) {
               box-shadow: inset 0 0 0 1.5px  hsl(74, 90%, 30%);
               border-color: hsl(74, 90%, 30%);
               background-color: hsl(74, 90%, 8%);
             }

             &:is(#city) {
               box-shadow: inset 0 0 0 1.5px  hsl(40, 90%, 30%);
               border-color: hsl(40, 90%, 30%);
               background-color: hsl(40, 90%, 8%);
             }

             &:is(#config) {
               box-shadow: inset 0 0 0 1.5px  hsl(175, 10%, 45%);
               border-color: hsl(175, 10%, 45%);
               background-color: hsl(175, 10%, 8%);
             }
             
           }
         }
         
         @media (pointer: fine) and (hover: hover) {
           #navbar button:hover:not(.chosen, :focus, :active) {
             &:is(#field) {
               border-color:hsl(74, 90%, 30%);
             }

             &:is(#city) {
               border-color: hsl(40, 90%, 30%);
             }

             &:is(#config) {
               border-color: hsl(175, 10%, 45%);
             }
           }
         }

         #logo {
           grid-area: logo;
         }

         main {
           grid-area: main;
           display: flex;
           flex-direction: column;
         }
         
         #story {
           flex: 1;
           overflow-y: auto;
           margin: 0;
           font-size: clamp(0.75rem, 1.5vw + 1.5vh, 1.3rem);
           font-weight:300;
           padding-left: 0.1rem;
           padding-right: 0.1rem;

           p {
             line-height: 1.15;
             text-align: justify;
             margin-bottom: 0.75rem;
           }

           .inputwrap {
             display: inline-block;
             position: relative;  
             font-size: 0.9em;
             padding-bottom: 1.5px;

             transition: width 0.25s linear;
             &:has(#getFirstName, #getLastName) {
               width: 5.5em;
               max-width: 8em;
             }
           }
           .inputwrap::before {
             content: "\200B"; /* zero-width space character */
             display: inline-block;
             height: 1em;
             visibility: hidden;
           }
           input, .fakeinput, p.fakeinput {
             position: absolute;
             top: 0; left: 0; bottom: 0; right: 0;
             background: color-mix(in hsl, var(--bgColor) 94%, var(--baseColor));
             padding: 0;
             border: 0;
             font-size: 1em;
             padding-bottom: 1.5px;
             border-bottom: 0.05em solid var(--baseColor);    
             caret-color: var(--baseColor);
             color: var(--baseColor);
             border-radius: 2px;
             outline: none;
             text-align: center;
             transition: width 0.25s linear, border-color 0.15s, background 0.15s;

             &.invalid {
               animation: invalid 0.18s forwards;
             }
             &.full {
               border-color:  hsl(3, 75%, 50%);
             }

           }

           .fakeinput, p.fakeinput {
             width: fit-content;
             transition: none !important;
           }

           .settled {
             background: var(--bgColor) !important;
             border-color: transparent !important;
           }

           #getFirstName, #getLastName, .fakegetname {
             font-family: vinque;
             width: 5.5em;
             max-width: 8em;
             color: var(--accent);
             border-color: var(--accent);
             caret-color: color-mix(in hsl, var(--bgColor) 30%, var(--accent));
             background: color-mix(in hsl, var(--bgColor) 94%, var(--baseColor));

             @starting-style {
               width: 0;
             }

           }

           .cue {
             font-size: 0.7em;
             opacity: 0;
             color: var(--accent);
             font-weight: 650;
             transition: opacity 0.2s 0.2s;
             position: relative;
             user-select: none;
             pointer-events: none;
             z-index: 2;
             position: relative;
             bottom: 0.85rem;
             
             &.enter::before {
               content: "enter";
               position: relative;
               display: inline-block;
               padding: 3px;
               bottom: 2px;           
               transition: scale 0.1s;
             }
             &::after {
               content: "";
               position: absolute;
               left: 0;
               top: 0;
               width: 100%;
               height: 100%;
               border: 1px solid var(--accent);
               border-bottom-width: 2px;
               border-radius: 3px;
               animation: cueing 0.5s linear infinite alternate;            
               transition: scale 0.1s;
             }

             &.visible {
               opacity: 0.8;
               cursor: pointer;
               pointer-events: all;
             }

             &.done, &.done::before, &.done::after {
               transition: opacity 0.2s, scale 0.3s !important;
               opacity: 0;
               scale: 0;
             }
           }
           

         }
         @keyframes cueing {
           from {opacity: 1; }
           to {opacity: 0.65; }
         }

         @keyframes invalid {
           0% {border-color: var(-accent);}
           50% {border-color: hsl(3, 75%, 70%); }
           100% {border-color: var(--accent); }
         }
         
         .sidebar#left {
           grid-area: left;
           display: flex;     
         }
         .sidebar#right {
           grid-area: right;
           display: flex;
         }

         #actionbar {
           grid-area: actionbar;
         }
         #dash {
           grid-area: dash;
         }
         #detail {
           grid-area: detail;
         }
         #updates {
           grid-area: updates;
         } 


         #logo, #dash, #detail, .sidebar#left { display: none; }
         
         /* DESKTOP VIEW */
         @media (min-width: 850px) {
           body {
             grid-template-columns: var(--sidebarWidth) 1fr var(--sidebarWidth);
             grid-template-rows: auto 1fr 0.2fr 0.1fr;
             grid-template-areas:
               "logo header right"
               "left   main   right"
               "dash   main   detail"             
               "dash   updates   detail";
           }
           
           #dash, #detail, .sidebar#left, .sidebar#right { display: flex; } /* show hidden panels */

           #navbar button {
             font-size: var(--topFontSize);
             img {height: 1.5em;}
           }
           .sidebar {
             width: var(--sidebarWidth);
           }
           
           #logo {
             grid-area: logo;
             display: flex;
             align-items: center;
             width: var(--sidebarWidth);
             justify-content: center;
             font-size: var(--topFontSize);
             cursor: pointer;
             transition: scale 0.05s;
             
             i {
               color: hsl(200, 30%, 70%);
               position: relative;
               top: 0.1rem;
               font-size: 1.05em;
               margin-right: 0.15rem;
             }
             #firstword {
               font-family: varsity;
               font-size: 1.25em;
               margin-right: 0.065rem;
               color: hsl(20, 70%, 48%);
             }
             #secondword {
               font-family: devinneswash;
               font-size: 1.1em;
               position: relative;
               bottom: 0.05em;
               color: hsl(45, 70%, 48%);
             }
           }
         }

         .nudged, .nudged::before, .nudged::after {
           scale: 0.985;
         }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>


    <body>
        <div id="logo" class="box nudge">
            <i class="ra ra-crossed-swords"></i>
            <span id="firstword">Fantasy</span>
            <span id="secondword">Fantasy</span>
        </div>
        <div id="navbar">
            <button id="field" class="box nudge"><img src="assets/compass.svg"> </button>
            <button id="city" class="box nudge"><img src="assets/city.svg"> </button>
            <button id="config" class="box nudge"><img src="assets/cog.svg"></button>
        </div>


        <aside class="sidebar box" id="left">
            <h1 class="filler"> ROSTER </h1>
        </aside>

        <main class="box">
            <div id="story">
            </div>
        </main>
        
        <aside class="box" id="dash">
            <h1 class="filler"> STATS </h1>
        </aside>


        <aside class="box" id="updates">
            <h1 class="filler"> LIVE UPDATES </h1>
        </aside>
        
        <aside class="box" id="detail">
            <h1 class="filler"> MISCELLANEA </h1>
        </aside>

        <aside class="sidebar box" id="right">
            <h1 class="filler"> KINGDOM MANAGEMENT </h1>
        </aside>

        <script type="module">
         import {typeOn, typeP, collapseP, typePWithInputs} from "./typing.js";


         document.getElementById("logo").onclick = () => location.href = location.href;
         document.querySelectorAll("#navbar button").forEach(b => b.onpointerdown = () => selectMain(b.id));

         document.querySelectorAll(".nudge").forEach(b =>
           b.addEventListener("pointerdown", () =>
             b.classList.add("nudged")
         ));
         document.onpointerup = () => {
           document.querySelectorAll(".nudged").forEach(b => b.classList.remove("nudged"));
         };

         const story = document.getElementById("story");
         let currentCue;

         function selectMain(topic) {
           document.querySelectorAll("#navbar button.chosen").forEach(b => b.classList.remove("chosen"));
           document.querySelector("#navbar button#" + topic).classList.add("chosen");
         }

         const beginTutorial = () => 
           typePWithInputs(story, "You jolt awake, your head spinning. What a wild dream that must have been. You can hardly even remember your own name... But of course, it is @ @!    ", ["getFirstName", "getLastName"], (e) => nameValidate(e), (p,inps) => getName(p, inps));

         const isAlphabetic = (text) => [...text].every(c => "abcdefghijklmnopqrstuvwxyz".includes(c.toLowerCase()));
         
         


         const getCue = (key, cb) => {
           const cue = document.createElement("span");
           cue.className = `cue ${key.toLowerCase()}`;
           cue.addEventListener("pointerdown", () =>
             cue.classList.add("nudged"));

           const wrap = (e) => {
             if (e.key == key) {
               document.removeEventListener("keydown", wrap);
               cue.removeEventListener("click", wrapClick);
               cue.classList.add("done");
               currentCue = null;
               cue.addEventListener("transitionend", function h() {
                 cue.removeEventListener("transitionend", h);
                 cue.remove();
                 cb();
               });
           }};
           const wrapClick = (e) => {
             document.removeEventListener("keydown", wrap);
             cue.removeEventListener("click", wrapClick);
             cue.classList.add("done");
             currentCue = null;
             cue.addEventListener("transitionend", function h() {
               cue.removeEventListener("transitionend", h);
               cue.remove();
               cb();
             });
           };
           document.addEventListener("keydown", wrap);
           cue.addEventListener("click", wrapClick);
           story.append(cue);
           return cue;
         };

         const clearInput = (p, cb=()=>{}) => {
           p.querySelectorAll(".inputwrap").forEach(i => {
             i.firstChild.classList.add("settled");
             i.style.transitionDuration = "";
             i.firstChild.style.transitionDuration = "";
           });
           const wrap = (e) => {
             cb();
             e.target.removeEventListener("transitionend", wrap);
           }
           p.querySelector("input").addEventListener("transitionend", wrap);
         };
         const getAppearance = (p) => {
           let n = 0;
           // elaborate process to collapse both the unnecessary spans (for performance) and the inputs so they mesh with the text
           clearInput(p, () => {
             collapseP(p, (i) =>`<span class='fakegetname settled' style='font-size: 0.9em; display: inline-block; text-align: center; width:${p.querySelectorAll("input")[n++].getBoundingClientRect().width}px; transition: width 0.2s;'>` + i + "</span>");
             document.querySelectorAll(".fakegetname").forEach( n => {
               let width = getTrueWidthName(n.innerText);
               n.style.width = width + "px";
             });
           });

           setTimeout(() => typeP("You roll out of bed, hoping you havenâ€™t missed the first bell. Your father said the meeting today had to be as early as possible. Maybe that explained the odd sleep: you had a feeling that this might be The Meeting, the one long awaited by any onlyborn child of a king.", story), 200);
         };

         function getTrueWidthName(text) {
           let p = document.createElement("p");
           p.className = "fakeinput fakegetname";
           p.style.color = "transparent";
           p.style.pointerEvents = "none";
           p.style.userSelect = "none";
           p.style.fontSize = "0.9em";

           story.append(p);
           p.innerText = text;

           let rect = p.getBoundingClientRect();
           let store = rect.width;
           p.remove();
           return store;
         }


         const getName = (p, inputs) => {
           const inputFirst = inputs[0];
           const inputSecond = inputs[1];
           currentCue = getCue("Enter", () => getAppearance(p));

           inputFirst.addEventListener("keydown", (e) => {if (e.key === " ") {e.preventDefault(); inputSecond.focus();}});
           
           setTimeout(() => {
             inputFirst.focus();
           }, 300);
         };

         
         const nameValidate = (e) => {
           if (!e.data) {
             if (!e.target.value) {
               e.target.classList.remove("full");
               e.target.style.transitionDuration = "";
               e.target.parentNode.transitionDuration = "";
               e.target.style.width = "";
               e.target.parentNode.style.width = "";
               currentCue.classList.remove("visible");
               return;
             }
           } else if (!isAlphabetic(e.data)) {
             let store = e.target.selectionStart - [...e.data].filter(c => !isAlphabetic(c)).length;
             const inputValue = e.target.value;
             const alphabeticValue = inputValue.replace(/[^a-zA-Z]/g, '');
             e.target.value = alphabeticValue;

             e.target.classList.add("invalid");
             
             e.target.selectionStart = store;
             e.target.selectionEnd = store;
           }
           

           if (e.target.value.length >= 15)
             e.target.classList.add("full");
           else
             e.target.classList.remove("full");


           if (e.target.value.length) {
             let store = e.target.selectionStart;
             
             e.target.value = e.target.value.charAt(0).toUpperCase() + e.target.value.slice(1).toLowerCase();

             e.target.selectionStart = store;
             e.target.selectionEnd = store;
             let width = getTrueWidthName(e.target.value) / 15 + "em";  // convert to em so as to adapt to screen change
             e.target.style.width = width;
             e.target.parentNode.style.width = width;


             setTimeout( () => {e.target.style.transitionDuration = "0s"; e.target.parentNode.style.transitionDuration = "0s"; }, 100);

             
             if (event.target.parentNode.nextElementSibling.nextElementSibling.firstChild?.value?.length || event.target.parentNode.previousSibling.previousSibling.firstChild?.value?.length)  {
               currentCue.classList.add("visible");
             } else {
               currentCue.classList.remove("visible");
             }
           };
         };

         beginTutorial();
        </script>
    </body>
</html>
