<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Fantasy Fantasy</title>
        <link rel="icon" type="image/svg" href="./assets/favicon.svg">

        <link rel="stylesheet" href="./assets/rpg-awesome.min.css" />

        <style>
         @font-face {
           font-family: RPGAwesome;
           src: url("fonts/rpgawesome-webfont.woff?v=0.1.0") format("woff");
         }
         @font-face {
           font-family: ysabeau;
           src: url("fonts/YsabeauOffice-VariableFont_wght.ttf") format("truetype");
         }
         @font-face {
           font-family: varsity;
           src: url("fonts/VarsityTeamBold.otf") format("opentype");
         }
         @font-face {
           font-family: devinneswash;
           src: url("fonts/DevinneSwash.ttf") format("truetype");
         }

         @font-face {
           font-family: vinque;
           src: url("fonts/Vinque Rg.otf") format("opentype");
         }

         :root {
           --boxGap: 0.5rem;
           --sidebarWidth: 22vw;

           --topFontSize: clamp(0.75rem, 1.5vw, 2rem);

           --bgColor: #010101;
           --baseColor: #e0e0e0;
           --boxColor: #e0e0e0;
           --accent: hsl(120, 82.5%, 45%);
           --accent: hsl(190, 82.5%, 45%);
         }


         *, *::before, *::after {
           box-sizing: border-box;
           scrollbar-width: none;
           -webkit-tap-highlight-color: transparent;
           -webkit-user-drag: none;
         }

         .box {
           background: var(--bgColor);
           border: 2px solid var(--boxColor);
           border-radius: 3px;
           padding: var(--boxGap);
         }

         html, body {
           padding: 0;
           margin: 0;
           width: 100%;
           height: 100%;
           overflow: hidden;
         }

         /* ASSUMES MOBILE */
         .wrapper {width: 100%; height: 100%;}
         body {
           background: var(--bgColor);
           color: var(--baseColor);
           font-family: ysabeau, monospace;
           display: grid;
           grid-template-rows: auto 1fr 0.5fr 0.15fr;
           grid-template-areas:
             "header header header"
             "main main main"
             "right right right"
             "updates updates updates";
           gap: var(--boxGap);
           padding: var(--boxGap);
           padding-bottom: calc(var(--boxGap) + 1px); /* extra pixel feels right */
         }

         p, h1, h2, h3 {
           margin: 0;
         }

         *:has(> .filler) { display: flex; justify-content: center; align-items: center;}         

         #navbar {
           display: flex;
           gap: var(--boxGap);
           overflow-x: auto;
           justify-content: center;
           flex: 1;
           align-items: center;
           width: 100%;
         }
         
         #navbar button {
           display: flex;
           align-items: center;
           justify-content: center;
           flex-grow: 1;
           color: var(--baseColor);
           height: 100%;
           font-weight: 600;
           font-size: 1.55rem;
           box-shadow: inset 0 0 0 1.5px var(--bgColor);

           transition: background 0.05s, border 0.05s, box-shadow 0.05s, scale 0.05s;
           white-space: nowrap;
           cursor: pointer;
           img {
             height: 1em;
             filter: invert(0.97);
             user-select: none;
           }

           &:focus, &:active, &.chosen {
             outline: none;
             border-color: var(--accent);
             box-shadow: inset 0 0 0 1.5px var(--accent);
           }
         }
         
         @media (pointer: fine) and (hover: hover) {
           #navbar button:hover {
             border-color: var(--accent);
           }
         }
         main {
           display: flex;
           flex-direction: column;
         }
         
         #story {
           flex: 1;
           overflow-y: auto;
           margin: 0;
           font-size: clamp(0.75rem, 1.5vw + 1.5vh, 1.3rem);
           font-weight:300;
           padding-left: 0.1rem;
           padding-right: 0.1rem;

           p {
             line-height: 1.15;
             text-align: justify;
             margin-bottom: 0.75rem;
           }

           .inputwrap {
             display: inline-block;
             position: relative;  
             font-size: 0.9em;
             padding-bottom: 1.5px;

             transition: width 0.25s linear;
             &:has(#getFirstName, #getLastName) {
               width: 5.5em;
               max-width: 8em;
             }
           }
           .inputwrap::before {
             content: "";
             display: inline-block;
             height: 1em;
             visibility: hidden;
           }
           input, .fakeinput, p.fakeinput {
             position: absolute;
             top: 0; left: 0; bottom: 0; right: 0;
             background: color-mix(in hsl, var(--bgColor) 94%, var(--baseColor));
             padding: 0;
             border: 0;
             font-size: 1em;
             padding-bottom: 1.5px;
             border-bottom: 0.05em solid var(--baseColor);    
             caret-color: var(--baseColor);
             color: var(--baseColor);
             border-radius: 2px;
             outline: none;
             text-align: center;
             transition: width 0.25s linear, border-color 0.15s, background 0.15s;

             &.invalid {
               animation: invalid 0.18s forwards;
             }
             &.full {
               border-color:  hsl(3, 75%, 50%);
             }

           }

           .fakeinput, p.fakeinput {
             width: fit-content;
             transition: none !important;
           }

           .settled {
             background: var(--bgColor) !important;
             border-color: transparent !important;
           }

           #getFirstName, #getLastName, .fakegetname {
             font-family: vinque;
             width: 5.5em;
             max-width: 8em;
             color: var(--accent);
             border-color: var(--accent);
             caret-color: color-mix(in hsl, var(--bgColor) 30%, var(--accent));
             background: color-mix(in hsl, var(--bgColor) 94%, var(--baseColor));

             @starting-style {
               width: 0;
             }

           }

           .cue {
             font-size: 1em;
             opacity: 0;
             color: var(--accent);
             font-weight: 650;
             transition: opacity 0.2s 0.2s;
             position: relative;
             user-select: none;
             pointer-events: none;
             z-index: 2;
             position: relative;
             bottom: 0.65rem;
             
             &.enter::before {
               content: "⏎";
               position: relative;
               display: inline-block;
               padding: 3px;
               padding-left: 8px;
               padding-right: 8px;
               bottom: 2px;           
               transition: scale 0.1s;
             }
             &::after {
               content: "";
               position: absolute;
               left: 0;
               top: 0;
               width: 100%;
               height: 100%;
               border: 1px solid var(--accent);
               border-bottom-width: 2px;
               border-radius: 3px;
               animation: cueing 0.5s linear infinite alternate;            
               transition: scale 0.1s;
             }

             &.visible {
               opacity: 0.8;
               cursor: pointer;
               pointer-events: all;
             }

             &.done, &.done::before, &.done::after {
               transition: opacity 0.2s, scale 0.3s !important;
               opacity: 0;
               scale: 0;
             }
           }
           

         }
         @keyframes cueing {
           from {opacity: 1; }
           to {opacity: 0.65; }
         }

         @keyframes invalid {
           0% {border-color: var(-accent);}
           50% {border-color: hsl(3, 75%, 70%); }
           100% {border-color: var(--accent); }
         }
         

         #logo-wrap    { grid-area: logo; }
         #navbar-wrap  { grid-area: header; }
         #left-wrap    { grid-area: left; }
         #right-wrap   { grid-area: right; }
         #dash-wrap    { grid-area: dash; }
         #detail-wrap  { grid-area: detail; }
         #updates-wrap { grid-area: updates; }
         #main-wrap    { grid-area: main; }
         

         .box {
           transition: opacity 0.1s;
           height: 100%;
           width: 100%;
           @starting-style {
             opacity: 0;
           }
         }


         #logo-wrap, #dash-wrap, #detail-wrap, #left-wrap { display: none; opacity: 0; }

         @media (width <= 850px) {
           body.keyboardactive {
             #alphaboard {
               display: grid;
             }
             #kingdom {
               display: none;
               opacity: 0;
             }
           }
         }

         .keyboard {
           width: 100%;
           height: 100%;
           background: var(--bgColor);
           border-color: var(--accent);
           display: none;

           transition: opacity 0.1s; 
           @starting-style {
             opacity: 0;
           }
           .key {
             background: transparent;
             border: 1.5px solid var(--accent);
             border-bottom-width: 2.25px;
             border-radius: 3px;
             color: var(--accent);
             font-weight: 750;
             font-size: 3vh;
             display: flex;
             align-items: center;
             justify-content: center;
             cursor: pointer;
             transition: transform .1s;
           }
           .key:active {
             transform: translateY(2px);
           }

           .key.action {
             grid-column: span 1;
           }

           .key.bkspc {
             background-image: url("./assets/bkspc.svg");
             background-size: 40%;
             background-repeat: no-repeat;
             background-position: center;
             filter: invert(56%) sepia(98%) saturate(2737%) hue-rotate(153deg) brightness(101%) contrast(84%);
             color: transparent;
           }
           .key.action:last-of-type {
             grid-column: span 2;
           }

         }

         #alphaboard {
           grid-template-columns: repeat(6, 1fr);    
           gap: 6px;                                
         }



         
         /* DESKTOP VIEW */
         @media (width > 850px) {
           body {
             grid-template-columns: var(--sidebarWidth) 1fr var(--sidebarWidth);
             grid-template-rows: auto 1fr 0.2fr 0.1fr;
             grid-template-areas:
               "logo header right"
               "left   main   right"
               "dash   main   detail"             
               "dash   updates   detail";
           }
           
           #dash-wrap, #detail-wrap, #left-wrap, #logo-wrap { display: flex; opacity: 1; } /* show hidden panels */

           #navbar button {
             font-size: var(--topFontSize);
             img {height: 1.5em;}
           }
           .sidebar {
             width: var(--sidebarWidth);
           }
           
           #logo {
             display: flex;
             align-items: center;
             width: var(--sidebarWidth);
             justify-content: center;
             font-size: var(--topFontSize);
             cursor: pointer;
             transition: scale 0.05s, opacity 0.1s;
             opacity: 1;
             
             i {
               color: hsl(200, 30%, 70%);
               position: relative;
               top: 0.1rem;
               font-size: 1.05em;
               margin-right: 0.15rem;
             }
             #firstword {
               font-family: varsity;
               font-size: 1.25em;
               margin-right: 0.065rem;
               color: hsl(20, 70%, 48%);
             }
             #secondword {
               font-family: devinneswash;
               font-size: 1.1em;
               position: relative;
               bottom: 0.05em;
               color: hsl(45, 70%, 48%);
             }
           }
         }

         .nudged, .nudged::before, .nudged::after {
           scale: 0.985;
         }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>

    <body>
        <div id="logo-wrap" class="wrapper">
            <div id="logo" class="box nudge">
                <i class="ra ra-crossed-swords"></i>
                <span id="firstword">Fantasy</span>
                <span id="secondword">Fantasy</span>
            </div>
        </div>

        <div id="navbar-wrap" class="wrapper">
            <div id="navbar">
                <button id="field" class="box nudge"><img src="assets/compass.svg"> </button>
                <button id="city" class="box nudge"><img src="assets/city.svg"> </button>
                <button id="config" class="box nudge"><img src="assets/cog.svg"></button>
            </div>
        </div>

        <div id="left-wrap" class="wrapper sidebar">
            <aside class="box" id="roster">
                <h1 class="filler"> ROSTER </h1>
            </aside>
        </div>

        <div id="main-wrap" class="wrapper">
            <main class="box">
                <div id="story"></div>
            </main>
        </div>

        <div id="updates-wrap" class="wrapper">
            <aside class="box" id="updates">
                <h1 class="filler"> LIVE UPDATES </h1>
            </aside>
            <aside class="keyboard" id="numboard">
                <div class="key">1</div><div class="key">2</div><div class="key">3</div>
                <div class="key">4</div><div class="key">5</div><div class="key">6</div>
                <div class="key">7</div><div class="key">8</div><div class="key">9</div>
                <div class="key">0</div><div class="key">.</div>
                <div class="key action bkspc">⟵</div>
                <div class="key action">⏎</div>
            </aside>
        </div>

        <div id="dash-wrap" class="wrapper">
            <aside class="box" id="dash">
                <h1 class="filler"> STATS </h1>
            </aside>
        </div>

        <div id="detail-wrap" class="wrapper">
            <aside class="box" id="detail">
                <h1 class="filler"> MISCELLANEA </h1>
            </aside>
        </div>

        <div id="right-wrap" class="wrapper sidebar">
            <aside class="box" id="kingdom">
                <h1 class="filler"> KINGDOM MANAGEMENT </h1>
            </aside>
            <aside id="alphaboard" class="keyboard">
                <div class="key">A</div><div class="key">B</div><div class="key">C</div><div class="key">D</div>
                <div class="key">E</div><div class="key">F</div><div class="key">G</div><div class="key">H</div>
                <div class="key">I</div><div class="key">J</div><div class="key">K</div><div class="key">L</div>
                <div class="key">M</div><div class="key">N</div><div class="key">O</div><div class="key">P</div>
                <div class="key">Q</div><div class="key">R</div><div class="key">S</div><div class="key">T</div>
                <div class="key">U</div><div class="key">V</div><div class="key">W</div><div class="key">X</div>
                <div class="key">Y</div><div class="key">Z</div>
                <div class="key action bkspc">⟵</div>
                <div class="key action">SPC</div>
                <div class="key action">⏎</div>
            </aside>
        </div>
    </body>



    <script type="module">
     import {typeOn, typeP, collapseP, typePWithInputs} from "./typing.js";


     document.getElementById("logo").onclick = () => location.href = location.href;
     document.querySelectorAll("#navbar button").forEach(b => b.onpointerdown = () => selectMain(b.id));

     document.querySelectorAll(".nudge").forEach(b =>
       b.addEventListener("pointerdown", () =>
         b.classList.add("nudged")
     ));
     document.onpointerup = () => {
       document.querySelectorAll(".nudged").forEach(b => b.classList.remove("nudged"));
     };

     document.querySelectorAll(".key").forEach(k => {
       k.tabIndex = 0;
       k.addEventListener("pointerdown", () =>
         k.classList.add("nudged")
       );
       k.onpointerdown = () => {
         k.focus();

         setTimeout( () => {
           let input = document.activeElement;
           switch(k.innerText) {
             case "⏎":
               input.dispatchEvent(
                 new KeyboardEvent('keydown', {
                   code: 'Enter',
                   key: 'Enter',
                   charCode: 13,
                   keyCode: 13,
                   view: window,
                   bubbles: true
                 })
               );
               break;
             case "SPC":
               input.dispatchEvent(
                 new KeyboardEvent('keydown', {
                   code: 'Space',
                   key: ' ',
                   charCode: 32,
                   keyCode: 32,
                   view: window,
                   bubbles: true
                 })
               );
               break;
             case "⟵":
               input.value = input.value.slice(0, -1);
               input.dispatchEvent(
                 new Event('input', { bubbles: true, cancelable: true })
               );
               break;
             default:
               input.value = input.value + k.innerText;
               input.dispatchEvent(
                 new Event('input', { bubbles: true, cancelable: true, data: k.innerText })
               );
           }
           
           
         }, 0);
       };
     });

     const story = document.getElementById("story");
     let currentCue;

     function selectMain(topic) {
       document.querySelectorAll("#navbar button.chosen").forEach(b => b.classList.remove("chosen"));
       document.querySelector("#navbar button#" + topic).classList.add("chosen");
     }

     const beginTutorial = () => 
       typePWithInputs(story, "You jolt awake, your head spinning. What a wild dream that must have been. You can hardly even remember your own name... But of course, it is @ @!    ", "5.5em", ["getFirstName", "getLastName"], (e) => nameValidate(e), (p,inps) => getName(p, inps));

     const isAlphabetic = (text) => [...text].every(c => "abcdefghijklmnopqrstuvwxyz".includes(c.toLowerCase()));
     
     


     const getCue = (key, cb) => {
       const cue = document.createElement("span");
       cue.className = `cue ${key.toLowerCase()}`;
       cue.addEventListener("pointerdown", () =>
         cue.classList.add("nudged"));

       const wrap = (e) => {
         if (e.key == key && cue.classList.contains("visible")) {
           document.removeEventListener("keydown", wrap);
           cue.removeEventListener("click", wrapClick);
           cue.classList.add("done");
           currentCue = null;
           cue.addEventListener("transitionend", function h() {
             cue.removeEventListener("transitionend", h);
             cue.remove();
             cb();
           });
       }};
       const wrapClick = (e) => {
         document.removeEventListener("keydown", wrap);
         cue.removeEventListener("click", wrapClick);
         cue.classList.add("done");
         currentCue = null;
         cue.addEventListener("transitionend", function h() {
           cue.removeEventListener("transitionend", h);
           cue.remove();
           cb();
         });
       };
       document.addEventListener("keydown", wrap);
       cue.addEventListener("click", wrapClick);
       story.append(cue);
       return cue;
     };

     const clearInput = (p, cb=()=>{}) => {
       p.querySelectorAll(".inputwrap").forEach(i => {
         i.firstChild.onblur = null;
         i.firstChild.onfocus = null;
         i.firstChild.classList.add("settled");
         i.style.transitionDuration = "";
         i.firstChild.style.transitionDuration = "";
       });
       document.body.classList.remove("keyboardactive");

       const wrap = (e) => {
         cb();
         e.target.removeEventListener("transitionend", wrap);
       }
       p.querySelector("input").addEventListener("transitionend", wrap);
     };
     const getAppearance = (p) => {
       let n = 0;
       // elaborate process to collapse both the unnecessary spans (for performance) and the inputs so they mesh with the text
       clearInput(p, () => {
         collapseP(p, (i) =>`<span class='fakegetname settled' style='font-size: 0.9em; display: inline-block; text-align: center; width:${p.querySelectorAll("input")[n++].getBoundingClientRect().width}px; transition: width 0.2s;'>` + i + "</span>");
         document.querySelectorAll(".fakegetname").forEach( n => {
           n.style.width =  getTrueWidthName(n.innerText) + "px";
           n.ontransitionend = () => n.style.width = "min-content";
         });
       });

       setTimeout(() => typeP("You roll out of bed, hoping you haven’t missed the first bell. Your father said the meeting today had to be as early as possible. Maybe that explained the odd sleep: you had a feeling that this might be The Meeting, the one long awaited by any onlyborn child of a king.", story), 200);
     };

     function getTrueWidthName(text) {
       let p = document.createElement("p");
       p.className = "fakeinput fakegetname";
       p.style.color = "transparent";
       p.style.pointerEvents = "none";
       p.style.userSelect = "none";
       p.style.fontSize = "0.9em";

       story.append(p);
       p.innerText = text;

       let rect = p.getBoundingClientRect();
       let store = rect.width;
       p.remove();
       return store;
     }


     const getName = (p, inputs) => {
       const inputFirst = inputs[0];
       const inputSecond = inputs[1];
       currentCue = getCue("Enter", () => getAppearance(p));

       inputFirst.addEventListener("keydown", (e) => {if (e.key === " ") {e.preventDefault(); inputSecond.focus();}});
       inputFirst.focus();
       inputFirst.onblur = (e) => {if (e.relatedTarget !== inputSecond) inputFirst.focus();};
       inputSecond.onblur = (e) => {if (e.relatedTarget !== inputFirst) inputSecond.focus()};


     };

     
     
     const nameValidate = (e) => {
       if (!e.data) {
         if (!e.target.value) {
           e.target.classList.remove("full");
           e.target.style.transitionDuration = "";
           e.target.parentNode.style.transitionDuration = "";
           e.target.style.width = "";
           e.target.parentNode.style.width = "";
           currentCue.classList.remove("visible");
           return;
         }
       } else if (!isAlphabetic(e.data)) {
         let store = e.target.selectionStart - [...e.data].filter(c => !isAlphabetic(c)).length;
         const inputValue = e.target.value;
         const alphabeticValue = inputValue.replace(/[^a-zA-Z]/g, '');
         e.target.value = alphabeticValue;

         e.target.classList.add("invalid");
         
         e.target.selectionStart = store;
         e.target.selectionEnd = store;
       }
       

       if (e.target.value.length >= 15)
         e.target.classList.add("full");
       else
         e.target.classList.remove("full");


       if (e.target.value.length) {
         let store = e.target.selectionStart;
         
         e.target.value = e.target.value.charAt(0).toUpperCase() + e.target.value.slice(1).toLowerCase();

         e.target.selectionStart = store;
         e.target.selectionEnd = store;
         let width = getTrueWidthName(e.target.value) / 15 + "em";  // convert to em so as to adapt to screen change
         e.target.style.width = width;
         e.target.parentNode.style.width = width;


         setTimeout( () => {e.target.style.transitionDuration = "0s"; e.target.parentNode.style.transitionDuration = "0s"; }, 100);

         
         if (event.target.parentNode.nextElementSibling.nextElementSibling.firstChild?.value?.length || event.target.parentNode.previousSibling.previousSibling.firstChild?.value?.length)  {
           currentCue.classList.add("visible");
         } else {
           currentCue.classList.remove("visible");
         }
       } else {
         e.target.style.transitionDuration = "";
         e.target.parentNode.style.transitionDuration = "";
         e.target.style.width = "";
         e.target.parentNode.style.width = "";
         currentCue.classList.remove("visible");
       }
     };
     beginTutorial();
    </script>
    </body>
</html>
